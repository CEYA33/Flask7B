<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Contacto</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.validation/1.19.2/jquery.validate.min.js"></script>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
</head>
<body>
    <p><b>Partiendo de los ejemplos introductorios a JQuery Validation para pruebas y de acuerdo al CDU dado:</b></p>
    <ul>
        <li>Coloca tu nombre y apellido.</li>
        <li>Añade las librerías, JQuery, JQuery Validation y Bootstrap.</li>
        <li>Diseña el formulario, recuerda usar las buenas prácticas usar ID, NAME y con valores únicos.</li>
        <li>Realiza las validaciones.</li>
        <li>Selecciona las excepciones y desarrollalas con el mensaje que hayas definido.</li>
    </ul>
    <p><b>Nombre del Alumno: Celeste Yazmín Becerra Saucedo</b></p>
    <!-- table index 1 -->
    <table class="table table-sm">
        <thead>
            <tr>
                <th colspan="2">
                    CDU 2
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <th>Nombre:</th>
                <td>Contacto.</td>
            </tr>
            <tr>
                <th>Actores:</th>
                <td>Visitante.</td>
            </tr>
            <tr>
                <th>Disparadores:</th>
                <td>Ninguno.</td>
            </tr>
            <tr>
                <th colspan="2">Flujo</th>
            </tr>
            <tr>
                <td colspan="2">
                    <p>El usuario accede a la opción "contacto" y llena datos en el formulario:</p>
                    <ul type="square">
                        <li>Correo Electrónico, requerido, email, mínimo 5 caracteres y máximo 50 caracteres.</li>
                        <li>Nombre, requerido, solo letras, mínimo 10 caracteres y máximo 50 caracteres.</li>
                        <li>Asunto, requerido, mínimo 10 caracteres y máximo 50 caracteres.</li>
                    </ul>
                    <p>Una vez lleno el formulario, da clic al botón que dice "Contactar".</p>
                </td>
            </tr>
            <tr>
                <th colspan="2">Excepciones</th>
            </tr>
            <tr>
                <td colspan="2">
                    <ul type="square">
                        <li>Si falla en los requeridos. <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en el mínimo/máximo caracteres. <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en el mínimo/máximo cantidad. <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en el solo números. <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en el solo números enteros. <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en el solo letras, alfanumérico, o en algún otro patrón. <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en el control de espacios (Multiples o sin estos). <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en alguna confirmación. <b>Poner el mensaje que dirá</b>.</li>
                        <li>Si falla en alguna otra validación. <b>Poner el mensaje que dirá</b>.</li>
                    </ul>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="container mt-5"></div>
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Nombre</th>
                    <th>Asunto</th>
                </tr>
            </thead>
            <tbody id="tbodyContacto"></tbody>
        </table>
    </div>
    
    <div class="container">
        <h2>Formulario de Contacto</h2>

        <form action="/registrar" method="GET" id="contactForm">
            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <input type="email" class="form-control" id="email" name="email" required minlength="5" maxlength="50">
            </div>
            <div class="form-group">
                <label for="nombre">Nombre</label>
                <input type="text" class="form-control" id="nombre" name="nombre" required pattern="[A-Za-z\s]+" minlength="10" maxlength="50">
            </div>
            <div class="form-group">
                <label for="asunto">Asunto</label>
                <input type="text" class="form-control" id="asunto" name="asunto" required minlength="10" maxlength="50">
            </div>
            <button type="submit" class="btn btn-primary">Contactar</button>
        </form>
    </div>

    <script>
        window.addEventListener("load", function (event) {
            $("#contactForm").validate({
                messages: {
                    email: {
                        required: "Por favor, ingresa tu correo electrónico.",
                        minlength: "El correo debe tener al menos 5 caracteres.",
                        maxlength: "El correo no puede tener más de 50 caracteres.",
                        email: "Por favor, ingresa un correo electrónico válido."
                    },
                    nombre: {
                        required: "Por favor, ingresa tu nombre.",
                        minlength: "El nombre debe tener al menos 10 caracteres.",
                        maxlength: "El nombre no puede tener más de 50 caracteres.",
                        pattern: "El nombre solo puede contener letras y espacios."
                    },
                    asunto: {
                        required: "Por favor, ingresa el asunto.",
                        minlength: "El asunto debe tener al menos 10 caracteres.",
                        maxlength: "El asunto no puede tener más de 50 caracteres."
                    }
                }
            });
        });
    </script>

    <script>
        window.addEventListener("load", function (event) {
            // Realizamos un SELECT a la BD con FLASK y lo imprimimos en el TBODY
            function buscar() {
                $.get("/buscar", function (respuesta) {
                    // Imprimimos la respuesta de FLASK con SELECT para saber cómo acceder a cada valor y colocarlos en el TBODY
                    console.log(respuesta)

                    $("#tbodyContacto").html("")

                    for (var x in respuesta) {
                        var contactoDatos = respuesta[x]
                        $("#tbodyContacto").append(`<tr>
                            <td>${contactoDatos[1]}</td>
                            <td>${contactoDatos[2]}</td>
                            <td>${contactoDatos[3]}</td>
                        </tr>`)
                    }
                })
            }

            buscar()

            Pusher.logToConsole = true
            
            var pusher = new Pusher("753bfbd057a6da283a0f", {
                cluster: "us2"
            })

            // Canal ---> Donde se concentran los hilos con los clientes conectados
            var channel = pusher.subscribe("canalRegistrosContacto");

            // Evento --> El código que se accionará con la información enviada o el uso del canal
            channel.bind("registroContacto", function (contactoDatos) {
                // 1. Notificar el evento
                alert("Ocurrió el evento")

                // 2. Recibir información enviada en el evento
                console.log(contactoDatos)

                // 3. Trabajar información enviada por el evento
                
                $("#tbodyContacto").prepend(`<tr>
                    <td>${contactoDatos.email}</td>
                    <td>${contactoDatos.nombre}</td>
                    <td>${contactoDatos.asunto}</td>
                    <td></td>
                </tr>`)
                

                // 4. Mandar a llamar otro código luego del evento
                buscar()
            })
        })
    </script>
</body>
</html>
